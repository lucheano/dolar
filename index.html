<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>CEDEARs — Monitor Data912</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f9f9f9; padding:20px; }
    table { border-collapse: collapse; width:100%; font-size:14px; background:#fff; }
    th, td { border:1px solid #ccc; padding:6px; text-align:center; }
    th { background:#333; color:#fff; }
    tr:nth-child(even){ background:#f4f4f4; }
    .positivo{ color:green; font-weight:bold; }
    .negativo{ color:red; font-weight:bold; }
  </style>
</head>
<body>

<h1>Monitor CEDEARs — Data912</h1>
<p>Datos desde <strong>data912.com/live/arg_cedears</strong> y <strong>dolarapi.com</strong>. Actualiza cada 20 s.</p>

<table>
  <thead>
    <tr>
      <th>Ticker</th>
      <th>Tipo de Cambio (CCL_mark)</th>
      <th>Cambio % (vs CCL_close)</th>
      <th>Spread vs CCL venta</th>
      <th>Volumen ARS</th>
      <th>Arbitrado</th>
    </tr>
  </thead>
  <tbody id="tabla"></tbody>
</table>

<script>
async function obtenerJSON(url){
  const res = await fetch(url);
  const texto = await res.text();
  try { return JSON.parse(texto); }
  catch(e){ console.error("Error al parsear JSON:", e, texto.slice(0,100)); return null; }
}

async function cargar(){
  try {
    // obtener CCL venta
    const dolarData = await obtenerJSON("https://dolarapi.com/v1/dolares");
    const cclVenta = dolarData.find(d=>d.casa==="contadoconliqui").venta;

    // obtener CEDEARs
    const data = await obtenerJSON("https://data912.com/live/arg_cedears");
    const tbody = document.getElementById("tabla");
    tbody.innerHTML = "";

    if(!data || !Array.isArray(data)){
      tbody.innerHTML = `<tr><td colspan="6">Sin datos válidos de Data912</td></tr>`;
      return;
    }

    data.forEach(papel=>{
      const ticker = papel.ticker_ar || papel.ticker_usa || "-";
      const mark   = Number(papel.CCL_mark)||0;
      const close  = Number(papel.CCL_close)||0;
      const vol    = Number(papel.ars_volume)||0;

      const cambio = close ? ((mark-close)/close)*100 : 0;
      const spread = cclVenta ? ((mark-cclVenta)/cclVenta)*100 : 0;
      const arbitrado = Math.abs(spread) <= 1; // dentro de ±1%

      const fila = document.createElement("tr");
      fila.innerHTML = `
        <td>${ticker}</td>
        <td>${mark.toFixed(2)}</td>
        <td class="${cambio>=0?"positivo":"negativo"}">${cambio>=0?"▲":"▼"} ${cambio.toFixed(2)}%</td>
        <td class="${spread>=0?"positivo":"negativo"}">${spread.toFixed(2)}%</td>
        <td>${vol.toLocaleString()}</td>
        <td>${arbitrado?"Sí":"No"}</td>
      `;
      tbody.appendChild(fila);
    });
  } catch(err){
    console.error("Error general:", err);
  }
}

cargar();
setInterval(cargar,20000);
</script>

</body>
</html>
