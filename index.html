<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>CEDEARs — Monitor</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root { --ok:#067d1b; --bad:#c5162b; --muted:#777; }
  body { font-family: Arial, system-ui, -apple-system, sans-serif; background:#f6f7f9; margin:0; padding:22px; }
  h1 { margin:0 0 8px 0; font-size:20px; }
  .meta { color:#555; font-size:12px; margin-bottom:12px; }
  table { width:100%; border-collapse: collapse; background:#fff; border-radius:12px; overflow:hidden; box-shadow: 0 2px 10px rgba(0,0,0,.06); }
  th, td { padding:9px 8px; border-bottom:1px solid #eee; text-align:center; }
  th { background:#111827; color:#fff; position: sticky; top:0; z-index:1; font-weight:600; }
  tr:nth-child(even) td { background:#fbfbfd; }
  .left { text-align:left; }
  .pos { color:var(--ok); font-weight:600; }
  .neg { color:var(--bad); font-weight:600; }
  .muted { color:var(--muted); }
  .chip { display:inline-block; padding:2px 6px; border-radius:999px; font-size:12px; background:#eef2ff; }
  .sortable { cursor:pointer; }
</style>
</head>
<body>

<h1>CEDEARs — Monitor</h1>
<div class="meta">Fuentes: data912 (lista, CCL implícito, volumen), dolarapi (CCL venta), BYMA/Pelotalibre (Precio ARS), Yahoo (Precio USD). Refresco cada 60s.</div>

<table id="tb">
  <thead>
    <tr>
      <th class="left">Ticker</th>
      <th class="sortable" data-col="precioArs" data-type="num">Precio ARS ↓</th>
      <th class="sortable" data-col="cambioArs" data-type="num">Cambio ARS</th>
      <th class="sortable" data-col="precioUsd" data-type="num">Precio USD</th>
      <th class="sortable" data-col="cambioUsd" data-type="num">Cambio USD</th>
      <th class="sortable" data-col="tc" data-type="num">Tipo de Cambio</th>
      <th class="sortable" data-col="vol" data-type="num">Volumen</th>
      <th class="sortable" data-col="arbitrado" data-type="str">Arbitrado</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
// ====== Config ======
const DATA912_URL     = "https://data912.com/live/arg_cedears";
const DOLARAPI_URL    = "https://dolarapi.com/v1/dolares";
const BYMA_URL        = "https://open.bymadata.com.ar/vanoms-be-core/rest/api/bymadata/free/cedears";
const PELotalibre_URL = "https://pelotalibre.digital/arg_cedears.json"; // fallback ARS (tiene 'c' y 'pct_change')
const ARBIT_THRESHOLD = 1.0; // ±1% contra CCL venta

// ====== Utiles ======
const fmt = (x, d=2) => (x==null || Number.isNaN(x)) ? "–" : Number(x).toFixed(d);
const arrow = (v) => v>0 ? "▲" : v<0 ? "▼" : "";
const clsPN = (v) => v>0 ? "pos" : v<0 ? "neg" : "muted";
const toYahoo = s => (s||"").replace(/\./g,"-").replace(/\//g,"-").toUpperCase();
async function robustJSON(url, opts) {
  const r = await fetch(url, opts);
  const t = await r.text();
  try {
    const j = JSON.parse(t);
    if (Array.isArray(j)) return j;
    if (j && Array.isArray(j.data)) return j.data;
    return j;
  } catch(e){ console.error("No es JSON:", url, t.slice(0,120)); return null; }
}

// ====== Fuentes ======
async function getCCLVenta() {
  const arr = await robustJSON(DOLARAPI_URL);
  if (!arr) return null;
  const ccl = arr.find(x => x.casa === "contadoconliqui");
  return ccl ? Number(ccl.venta) : null;
}

async function getData912() {
  return await robustJSON(DATA912_URL) || [];
}

// BYMA: intento real de precio ARS y variación ARS
async function getArsBymaMap() {
  try {
    const body = { excludeZeroPxAndQty: true, T1: true, T0: false };
    const r = await robustJSON(BYMA_URL, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });
    if (!Array.isArray(r)) return {};
    // Intento mapear por campos comunes (varían con versiones). Soporto varios alias.
    const map = {};
    for (const o of r) {
      const sym = (o.symbol || o.ticker || o.symbolCode || o.especie || o.Symbol || "").toUpperCase();
      if (!sym) continue;
      const last = o.last || o.ultimoPrecio || o.precio || o.p || o.lastPrice;
      const chgP = o.changePercent ?? o.varPct ?? o.variacion ?? o.pct_change;
      map[sym] = {
        price: last!=null ? Number(last) : null,
        changePct: chgP!=null ? Number(chgP) : null
      };
    }
    return map;
  } catch(e) {
    console.warn("BYMA no disponible, uso fallback:", e);
    return {};
  }
}

// Fallback ARS (tu JSON: {symbol, c, pct_change})
async function getArsFallbackMap() {
  try {
    const arr = await robustJSON(PELotalibre_URL);
    if (!Array.isArray(arr)) return {};
    const map = {};
    for (const o of arr) {
      const sym = (o.symbol||"").toUpperCase();
      if (!sym) continue;
      map[sym] = { price: Number(o.c), changePct: Number(o.pct_change) };
    }
    return map;
  } catch(e){ console.warn("Fallback ARS no disponible:", e); return {}; }
}

// USD: solo para Precio USD y Cambio USD
async function getUsdYahooMap(usTickers) {
  const uniq = Array.from(new Set(usTickers.map(toYahoo).filter(Boolean)));
  if (uniq.length===0) return {};
  // Yahoo quote endpoint (multi-símbolo)
  const url = "https://query1.finance.yahoo.com/v7/finance/quote?symbols="+encodeURIComponent(uniq.join(","));
  try {
    const r = await robustJSON(url);
    const out = {};
    const res = r?.quoteResponse?.result || [];
    for (const q of res) {
      const sym = (q.symbol||"").toUpperCase();
      const price = q.regularMarketPrice ?? null;
      const prev  = q.regularMarketPreviousClose ?? null;
      const chg = (prev && prev!==0 && price!=null) ? ((price - prev)/prev)*100 : null;
      out[sym] = { price, changePct: chg };
    }
    return out;
  } catch(e){ console.warn("Yahoo falló (USD queda en –):", e); return {}; }
}

// ====== Render ======
function render(rows, sortBy="precioArs", desc=true) {
  const tb = document.querySelector("#tb tbody");
  tb.innerHTML = "";
  const dir = desc ? -1 : 1;

  const sortKey = (r) => {
    const v = r[sortBy];
    if (v==null) return desc ? Number.NEGATIVE_INFINITY : Number.POSITIVE_INFINITY;
    return Number(v);
  };
  rows.sort((a,b) => (sortKey(a)>sortKey(b)?1:-1)*dir);

  for (const r of rows) {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="left">${r.tickerAr||"–"}</td>
      <td>${fmt(r.precioArs)}</td>
      <td class="${clsPN(r.cambioArs)}">${arrow(r.cambioArs)} ${r.cambioArs==null?"–":fmt(r.cambioArs,2)+"%"}</td>
      <td>${r.precioUsd==null?"–":fmt(r.precioUsd)}</td>
      <td class="${clsPN(r.cambioUsd)}">${r.cambioUsd==null?"–":(arrow(r.cambioUsd)+" "+fmt(r.cambioUsd,2)+"%")}</td>
      <td>${r.tc==null?"–":fmt(r.tc)}</td>
      <td>${r.vol==null?"–":fmt(r.vol,0)}</td>
      <td><span class="chip" style="background:${r.arbitrado?'#e6ffed':'#ffecec'};color:${r.arbitrado?'#03650f':'#7f0a0a'}">${r.arbitrado?'Sí':'No'}</span></td>
    `;
    tb.appendChild(tr);
  }
}

// ====== Main ======
let currentSort = { col:"precioArs", desc:true };

async function load() {
  try {
    const [data912, cclVenta] = await Promise.all([getData912(), getCCLVenta()]);
    // ARS (BYMA o fallback)
    let arsMap = await getArsBymaMap();
    if (!Object.keys(arsMap).length) {
      arsMap = await getArsFallbackMap();
    }
    // USD (Yahoo) — solo para columnas USD
    const usdMap = await getUsdYahooMap(data912.map(x => x.ticker_usa||"").filter(Boolean));

    const rows = [];
    for (const it of data912) {
      const tickerAr  = (it.ticker_ar||"").toUpperCase();
      const tickerUsa = (it.ticker_usa||"").toUpperCase();
      const keyARS    = tickerAr;     // ARS map usa CEDEAR (AAPL, TSLA, etc.)
      const keyUSD    = toYahoo(tickerUsa); // USD map usa formato Yahoo

      const cclMark = it.CCL_mark!=null ? Number(it.CCL_mark) : null;
      const volARS  = it.ars_volume!=null ? Number(it.ars_volume) : null;

      // ARS
      const a = arsMap[keyARS] || {};
      const precioArs  = a.price ?? null;
      const cambioArs  = a.changePct ?? null;

      // USD
      const u = usdMap[keyUSD] || {};
      const precioUsd  = u.price ?? null;
      const cambioUsd  = u.changePct ?? null;

      // Tipo de Cambio (según data912)
      const tc = cclMark;

      // Arbitrado (comparación con CCL venta)
      let arbitrado = null;
      if (tc!=null && cclVenta!=null) {
        const spreadPct = ((tc - cclVenta)/cclVenta)*100;
        arbitrado = Math.abs(spreadPct) <= ARBIT_THRESHOLD;
      }

      rows.push({
        tickerAr, tickerUsa,
        precioArs, cambioArs,
        precioUsd, cambioUsd,
        tc, vol: volARS,
        arbitrado
      });
    }

    render(rows, currentSort.col, currentSort.desc);
  } catch (e) {
    console.error(e);
    const tb = document.querySelector("#tb tbody");
    tb.innerHTML = `<tr><td colspan="8" class="muted">No se pudieron cargar los datos.</td></tr>`;
  }
}

// Sorting UI
document.querySelectorAll("th.sortable").forEach(th=>{
  th.addEventListener("click", ()=>{
    const col = th.dataset.col;
    const type = th.dataset.type || "str";
    if (currentSort.col === col) currentSort.desc = !currentSort.desc;
    else { currentSort.col = col; currentSort.desc = true; }
    load(); // vuelve a renderizar ordenado
    // Indicador header ↓/↑ solo en "Precio ARS"
    document.querySelectorAll("th.sortable").forEach(x=>{
      if (x.dataset.col==="precioArs") {
        x.textContent = "Precio ARS " + (currentSort.col==="precioArs" ? (currentSort.desc?"↓":"↑") : "↓");
      }
    });
  });
});

// Primera carga + refresco
load();
setInterval(load, 60000);
</script>

</body>
</html>
