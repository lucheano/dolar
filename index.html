<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Arbitraje CEDEARs</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f9f9f9; padding:20px; }
    .header { display:flex; align-items:center; gap:16px; flex-wrap:wrap; }
    .pill { background:#fff; border:1px solid #ccc; padding:6px 10px; border-radius:999px; font-size:14px; }
    table { border-collapse: collapse; width:100%; background:#fff; font-size:14px; margin-top:12px; }
    th, td { border:1px solid #ccc; padding:6px; text-align:center; }
    th { background:#333; color:#fff; position:sticky; top:0; }
    tr:nth-child(even){ background:#f4f4f4; }
    .positivo{ color:green; font-weight:bold; }
    .negativo{ color:red; font-weight:bold; }
    .muted{ color:#777; }
    .left { text-align:left; }
  </style>
</head>
<body>

<div class="header">
  <h1 style="margin:0;">Arbitraje CEDEARs</h1>
  <span id="cclPill" class="pill">CCL: –</span>
</div>
<p style="margin:8px 0 16px;">Fuentes: <strong>data912.com</strong>, <strong>dolarapi.com</strong>, <strong>dolarhoy.dev.ar</strong></p>

<table>
  <thead>
    <tr>
      <th class="left">Ticker</th>
      <th>Ratio</th>
      <th>Cotización USA (USD)</th>
      <th>Precio CEDEAR (ARS)</th>
      <th>Precio CEDEAR (USD)</th>
      <th>Precio CEDEAR esperado (USD)</th>
      <th>Precio Esperado (ARS)</th>
      <th>Diferencia % ARS</th>
      <th>Diferencia % USD</th>
    </tr>
  </thead>
  <tbody id="tabla"></tbody>
</table>

<script>
const URL_CEDEARS = "https://data912.com/live/arg_cedears";
const URL_USA     = "https://data912.com/live/usa_stocks";
const URL_DOLAR   = "https://dolarapi.com/v1/dolares";
const URL_RATIOS  = "https://dolarhoy.dev.ar/ratios.json"; // ajusta si lo guardaste en otra ruta

const fmt  = (x, d=2) => (x==null || isNaN(x)) ? "–" : Number(x).toFixed(d);
const arrow= v => v>0 ? "▲" : v<0 ? "▼" : "";
const clsPN= v => v>0 ? "positivo" : v<0 ? "negativo" : "muted";

async function fetchJSON(url){
  const r = await fetch(url);
  const t = await r.text();
  try { return JSON.parse(t); } catch(e){ console.error("JSON inválido en", url, e, t.slice(0,200)); return null; }
}

// helper por si algún símbolo USA viene con sufijos (p.ej. ABEV3)
function findUSA(mapUSA, symbol) {
  if (mapUSA[symbol]) return mapUSA[symbol];
  // intentar quitar dígitos/sufijos si no está (casos puntuales)
  const alt = symbol.replace(/\d+$/, "");
  return mapUSA[alt] || null;
}

async function loadData(){
  try{
    const [cedears, usaStocks, dolarData, ratiosData] = await Promise.all([
      fetchJSON(URL_CEDEARS),
      fetchJSON(URL_USA),
      fetchJSON(URL_DOLAR),
      fetchJSON(URL_RATIOS)
    ]);

    // CCL venta + etiqueta de fecha
    const cclObj = Array.isArray(dolarData) ? dolarData.find(d => d.casa === "contadoconliqui") : null;
    const CCL    = cclObj ? Number(cclObj.venta) : null;
    const cclLbl = CCL ? `CCL venta: ${fmt(CCL,1)} (act: ${new Date(cclObj.fechaActualizacion).toLocaleString()})` : "CCL: –";
    document.getElementById("cclPill").textContent = cclLbl;

    if (!Array.isArray(cedears) || !Array.isArray(usaStocks)) {
      document.getElementById("tabla").innerHTML = `<tr><td colspan="9" class="muted">Sin datos válidos</td></tr>`;
      return;
    }

    const ratios = (ratiosData && (ratiosData.ratios || ratiosData)) || [];
    const mapRatios  = Object.fromEntries(ratios.map(r => [r.ticker, r.ratio]));
    const mapUSA     = Object.fromEntries(usaStocks.map(s => [s.symbol, s]));
    const mapCedears = Object.fromEntries(cedears.map(c => [c.symbol, c]));

    const tbody = document.getElementById("tabla");
    tbody.innerHTML = "";

    // Recorremos solo los tickers ARS (no los que terminan en D)
    for (const symbol in mapCedears) {
      if (symbol.endsWith("D")) continue;

      const ratio = mapRatios[symbol];
      if (!ratio) continue; // si no tenemos ratio, no podemos arbitrar correctamente

      const rowARS = mapCedears[symbol];
      const rowUSDcedear = mapCedears[symbol + "D"]; // misma base + "D" → precio CEDEAR en USD
      const rowUSA = findUSA(mapUSA, symbol);        // precio USA real desde usa_stocks

      // Necesitamos al menos USA y ARS para evaluar
      if (!rowUSA || !rowARS || !CCL) continue;

      const precioUSA = Number(rowUSA.c) || null;             // Cotización USA (USD) — campo c
      const precioARS = Number(rowARS.c) || null;              // Precio CEDEAR (ARS) — campo c
      const precioUSDcedear = Number(rowUSDcedear?.c) || null; // Precio CEDEAR en USD — campo c del ticker + "D"

      // Precio CEDEAR esperado (USD) = Cotización USA / ratio
      const precioCEDEAR_esp_USD = (precioUSA && ratio) ? (precioUSA / ratio) : null;

      // Precio esperado (ARS) = Cotización USA * ratio * CCL
      const precioEsperadoARS = (precioUSA && ratio && CCL) ? (precioUSA * ratio * CCL) : null;

      // Diferencias
      const diffARS = (precioARS!=null && precioEsperadoARS)
        ? ((precioARS - precioEsperadoARS) / precioEsperadoARS) * 100
        : null;

      const diffUSD = (precioUSDcedear!=null && precioCEDEAR_esp_USD)
        ? ((precioUSDcedear - precioCEDEAR_esp_USD) / precioCEDEAR_esp_USD) * 100
        : null;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="left">${symbol}</td>
        <td>${ratio}:1</td>
        <td>${fmt(precioUSA)}</td>
        <td>${fmt(precioARS)}</td>
        <td>${fmt(precioUSDcedear)}</td>
        <td>${fmt(precioCEDEAR_esp_USD)}</td>
        <td>${fmt(precioEsperadoARS)}</td>
        <td class="${diffARS==null?'muted':clsPN(diffARS)}">${diffARS==null?'–':(arrow(diffARS)+' '+fmt(diffARS)+'%')}</td>
        <td class="${diffUSD==null?'muted':clsPN(diffUSD)}">${diffUSD==null?'–':(arrow(diffUSD)+' '+fmt(diffUSD)+'%')}</td>
      `;
      tbody.appendChild(tr);
    }
  }catch(e){
    console.error("Error:", e);
    document.getElementById("tabla").innerHTML =
      `<tr><td colspan="9" class="muted">Error al cargar datos.</td></tr>`;
  }
}

loadData();
setInterval(loadData, 90000); // refresca cada 90s
</script>

</body>
</html>
