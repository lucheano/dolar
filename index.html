<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Arbitraje CEDEARs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#f7f7f7; --fg:#222; --muted:#777; --border:#ddd; --head:#333; --green:#0a8a0a; --red:#c62828; }
    html,body { margin:0; padding:0; background:var(--bg); color:var(--fg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    .wrap { max-width:1200px; margin:32px auto; padding:0 16px; }
    .head { display:flex; align-items:center; gap:12px; flex-wrap:wrap; justify-content:space-between; margin-bottom:12px; }
    .title { display:flex; align-items:center; gap:12px; }
    .pill { background:#fff; border:1px solid var(--border); padding:6px 10px; border-radius:999px; font-size:14px; }
    .pill small { color:var(--muted); font-weight:400; }
    .toolbar { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .input { background:#fff; border:1px solid var(--border); border-radius:8px; padding:8px 10px; min-width:220px; font-size:14px; }
    table { width:100%; border-collapse:collapse; background:#fff; box-shadow:0 1px 3px rgba(0,0,0,.04); }
    th, td { border:1px solid var(--border); padding:8px 10px; text-align:center; font-size:14px; }
    th { position:sticky; top:0; background:var(--head); color:#fff; z-index:1; cursor:pointer; user-select:none; }
    th.left, td.left { text-align:left; }
    tr:nth-child(even) td { background:#fafafa; }
    .muted { color:var(--muted); }
    .underval { color:var(--green); font-weight:700; } /* dif < 0: subvaluado → verde */
    .overval  { color:var(--red); font-weight:700; }   /* dif > 0: sobrevaluado → rojo */
    .sort-ind { opacity:.9; margin-left:6px; font-size:11px; }
    abbr { text-decoration:underline dotted; cursor:help; }
    .footnote { margin-top:10px; color:var(--muted); font-size:12px; }
  </style>
</head>
<body>
<div class="wrap">

  <div class="head">
    <div class="title">
      <h1 style="margin:0;">Arbitraje CEDEARs</h1>
      <span id="pillCCL" class="pill" title="Contado con Liquidación (venta) según DolarAPI">CCL: –</span>
    </div>
    <div class="toolbar">
      <input id="search" class="input" type="text" placeholder="Filtrar por ticker… (p. ej., AAPL)" />
    </div>
  </div>

  <table id="tabla">
    <thead>
      <tr>
        <th class="left" data-key="ticker" data-type="str">
          <abbr title="Símbolo del CEDEAR en el mercado argentino">Ticker</abbr>
          <span class="sort-ind"></span>
        </th>
        <th data-key="ratio" data-type="num">
          <abbr title="Relación CEDEAR:Acción subyacente (p. ej., 20:1)">Ratio</abbr>
          <span class="sort-ind"></span>
        </th>
        <th data-key="precioUSA" data-type="num">
          <abbr title="Precio de la acción original en el mercado de EE.UU. (US$)">Acción USA (USD)</abbr>
          <span class="sort-ind"></span>
        </th>
        <th data-key="precioARS" data-type="num">
          <abbr title="Último precio del CEDEAR en pesos argentinos">CEDEAR (ARS)</abbr>
          <span class="sort-ind"></span>
        </th>
        <th data-key="precioUSDcedear" data-type="num">
          <abbr title="Precio del CEDEAR expresado en dólares (símbolo con sufijo D)">CEDEAR (USD)</abbr>
          <span class="sort-ind"></span>
        </th>
        <th data-key="precioCEDEAR_esp_USD" data-type="num">
          <abbr title="Precio teórico del CEDEAR en USD = (Acción USA / Ratio)">Precio teórico CEDEAR (USD)</abbr>
          <span class="sort-ind"></span>
        </th>
        <th data-key="diffUSD" data-type="num">
          <abbr title="(CEDEAR USD − Teórico USD) / Teórico USD">Diferencia % USD</abbr>
          <span class="sort-ind"></span>
        </th>
        <th data-key="precioEsperadoARS" data-type="num">
          <abbr title="Precio teórico del CEDEAR en ARS = (Acción USA / Ratio) × CCL">Precio teórico CEDEAR (ARS)</abbr>
          <span class="sort-ind"></span>
        </th>
        <th data-key="diffARS" data-type="num">
          <abbr title="(CEDEAR ARS − Teórico ARS) / Teórico ARS">Diferencia % ARS</abbr>
          <span class="sort-ind"></span>
        </th>
      </tr>
    </thead>
    <tbody id="tbody">
      <tr><td colspan="9" class="muted">Cargando…</td></tr>
    </tbody>
  </table>

  <div id="meta" class="footnote"></div>

</div>

<script>
/* Endpoints */
const URL_CEDEARS = "https://data912.com/live/arg_cedears";
const URL_USA     = "https://data912.com/live/usa_stocks";
const URL_DOLAR   = "https://dolarapi.com/v1/dolares";
const URL_RATIOS  = "https://dolarhoy.dev.ar/ratios.json";

/* Utils */
const fmt = (x, d=2) => (x==null || isNaN(x)) ? "–" : Number(x).toFixed(d);
const arrow = v => v>0 ? "▲" : (v<0 ? "▼" : "");
const clsVal = v => v==null ? "muted" : (v < 0 ? "underval" : "overval");

/* State */
let rows = [];
let viewRows = [];
let sortState = { key:"", dir: 0 }; // ✅ solo una vez
let CCL = null;

/* Fetch helper */
async function j(url){
  const r = await fetch(url);
  const t = await r.text();
  try { return JSON.parse(t); } catch(e){ console.error("JSON inválido en", url, e, t.slice(0,200)); return null; }
}

/* Fuzzy USA symbol */
function findUSA(mapUSA, symbol) {
  if (mapUSA[symbol]) return mapUSA[symbol];
  const alt = symbol.replace(/\d+$/,"");
  return mapUSA[alt] || null;
}

/* Build dataset */
async function loadAll(){
  const [argCedears, usaStocks, dolar, ratiosData] = await Promise.all([
    j(URL_CEDEARS), j(URL_USA), j(URL_DOLAR), j(URL_RATIOS)
  ]);

  // CCL (venta) + pill
  const cclObj = Array.isArray(dolar) ? dolar.find(d => d.casa === "contadoconliqui") : null;
  CCL = cclObj ? Number(cclObj.venta) : null;
  document.getElementById("pillCCL").textContent =
    CCL ? `CCL: ${fmt(CCL,1)} • ${new Date(cclObj.fechaActualizacion).toLocaleString()}` : "CCL: –";

  if (!Array.isArray(argCedears) || !Array.isArray(usaStocks) || !ratiosData){
    document.getElementById("tbody").innerHTML = `<tr><td colspan="9" class="muted">Sin datos válidos</td></tr>`;
    return;
  }

  const ratios = ratiosData.ratios || ratiosData;
  const mapRatio  = Object.fromEntries(ratios.map(r => [String(r.ticker).toUpperCase(), Number(r.ratio)]));
  const mapARSUSD = Object.fromEntries(argCedears.map(o => [String(o.symbol).toUpperCase(), o]));
  const mapUSA    = Object.fromEntries(usaStocks.map(o => [String(o.symbol).toUpperCase(), o]));

  const out = [];
  for (const [sym, ar] of Object.entries(mapARSUSD)) {
    if (sym.endsWith("D")) continue;
    const ratio = mapRatio[sym];
    if (!ratio) continue;

    const usdRowCEDEAR = mapARSUSD[sym + "D"];
    let usaRow = findUSA(mapUSA, sym);

    const precioUSA           = usaRow ? Number(usaRow.c) : null;
    const precioARS           = ar?.c != null ? Number(ar.c) : null;
    const precioUSDcedear     = usdRowCEDEAR?.c != null ? Number(usdRowCEDEAR.c) : null;
    const precioCEDEAR_esp_USD = (precioUSA!=null && ratio) ? (precioUSA / ratio) : null;
    const precioEsperadoARS   = (precioCEDEAR_esp_USD!=null && CCL) ? (precioCEDEAR_esp_USD * CCL) : null;

    const diffUSD = (precioUSDcedear!=null && precioCEDEAR_esp_USD) ? ((precioUSDcedear - precioCEDEAR_esp_USD) / precioCEDEAR_esp_USD) * 100 : null;
    const diffARS = (precioARS!=null && precioEsperadoARS) ? ((precioARS - precioEsperadoARS) / precioEsperadoARS) * 100 : null;

    out.push({ ticker:sym, ratio, precioUSA, precioARS, precioUSDcedear, precioCEDEAR_esp_USD, precioEsperadoARS, diffUSD, diffARS });
  }

  rows = out;
  viewRows = rows.slice();
  render();
  updateMeta();
}

/* Render */
function render(){
  const tb = document.getElementById("tbody");
  if (!viewRows.length){
    tb.innerHTML = `<tr><td colspan="9" class="muted">Sin resultados</td></tr>`;
    return;
  }
  tb.innerHTML = viewRows.map(r => `
    <tr>
      <td class="left">${r.ticker}</td>
      <td>${r.ratio ? `${r.ratio}:1` : "–"}</td>
      <td>${fmt(r.precioUSA)}</td>
      <td>${fmt(r.precioARS)}</td>
      <td>${fmt(r.precioUSDcedear)}</td>
      <td>${fmt(r.precioCEDEAR_esp_USD)}</td>
      <td class="${clsVal(r.diffUSD)}">${r.diffUSD==null?'–':(arrow(r.diffUSD)+' '+fmt(r.diffUSD)+'%')}</td>
      <td>${fmt(r.precioEsperadoARS)}</td>
      <td class="${clsVal(r.diffARS)}">${r.diffARS==null?'–':(arrow(r.diffARS)+' '+fmt(r.diffARS)+'%')}</td>
    </tr>
  `).join("");
}

/* Search */
document.getElementById("search").addEventListener("input", (e)=>{
  const q = e.target.value.trim().toUpperCase();
  viewRows = rows.filter(r => !q || String(r.ticker).includes(q));
  applySort();
  render();
  updateMeta();
});

/* Sorting */
function applySort(){
  if (!sortState.key || !sortState.dir) return;
  const ths = document.querySelectorAll("thead th");
  ths.forEach(th => { const i = th.querySelector(".sort-ind"); if (i) i.textContent = ""; });

  const th = Array.from(ths).find(t => t.dataset.key === sortState.key);
  if (th) th.querySelector(".sort-ind").textContent = sortState.dir > 0 ? "▲" : "▼";

  const type = th?.dataset.type || "str";
  viewRows.sort((a,b)=>{
    const va = a[sortState.key], vb = b[sortState.key];
    if (type === "num"){
      const na = (va==null || isNaN(va)) ? -Infinity : Number(va);
      const nb = (vb==null || isNaN(vb)) ? -Infinity : Number(vb);
      return sortState.dir * (na - nb);
    } else {
      return sortState.dir * String(va||"").localeCompare(String(vb||""));
    }
  });
}

document.querySelectorAll("thead th").forEach(th=>{
  th.addEventListener("click", ()=>{
    const key = th.dataset.key;
    if (!key) return;
    if (sortState.key !== key) sortState = { key, dir: 1 };
    else sortState.dir = sortState.dir === 1 ? -1 : (sortState.dir === -1 ? 0 : 1);

    if (sortState.dir === 0){
      sortState.key = "";
      document.querySelectorAll(".sort-ind").forEach(el=> el.textContent="");
      const q = document.getElementById("search").value.trim().toUpperCase();
      viewRows = rows.filter(r => !q || String(r.ticker).includes(q));
    } else {
      applySort();
    }
    render();
  });
});

/* Meta */
function updateMeta(){
  const meta = document.getElementById("meta");
  meta.textContent = `Mostrando ${viewRows.length} de ${rows.length} CEDEARs • Fuentes: data912 (20s), DolarAPI`;
}

/* Init */
loadAll();
setInterval(loadAll, 120000);
</script>

</body>
</html>
