<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Monitor CEDEARs Avanzado</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
    table { border-collapse: collapse; width: 100%; background: #fff; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background: #333; color: #fff; }
    .positivo { color: green; }
    .negativo { color: red; }
    .flecha { font-weight: bold; }
  </style>
</head>
<body>
  <h1>CEDEARs — Arbitraje y Cambios</h1>
  <table>
    <thead>
      <tr>
        <th>Símbolo</th>
        <th>Precio ARS</th>
        <th>Precio USD</th>
        <th>Ratio</th>
        <th>Teórico ARS</th>
        <th>Spread %</th>
        <th>Cambio ARS</th>
        <th>Cambio USD</th>
      </tr>
    </thead>
    <tbody id="tablaCedears"></tbody>
  </table>

  <script>
    // Función para obtener datos de CEDEARs desde data912
    async function fetchCedears() {
      const resp = await fetch("https://data912.com/live/arg_cedears");
      const cedears = await resp.json();
      return cedears;
    }

    // Función para obtener precios en USD de las acciones subyacentes
    // Podés usar alguna API tipo Yahoo Finance o similar
    async function fetchUSDPrice(symbol) {
      // Ejemplo ficticio: llamamos a tu backend que obtiene el precio en USD
      const resp = await fetch(`/api/usd-price?symbol=${symbol}`);
      const data = await resp.json();
      // data debe tener: { price: ..., previousClose: ... }
      return data;
    }

    // Función para obtener CCL (venta) desde dolarapi
    async function fetchCCL() {
      const resp = await fetch("https://dolarapi.com/v1/dolares");
      const arr = await resp.json();
      const obj = arr.find(d => d.casa === "contadoconliqui");
      return obj ? obj.venta : null;
    }

    // Supongamos que tenemos un JSON con los ratios (podés mantenerlo tú mismo o tener un endpoint)
    async function fetchRatios() {
      const resp = await fetch("/api/cedear-ratios"); 
      // debería devolver un objeto tipo { "AAPL": 10, "VISA": 18, ... }
      const ratios = await resp.json();
      return ratios;
    }

    // Función para armar la tabla
    async function actualizarTabla() {
      try {
        const cedears = await fetchCedears();
        const ccl = await fetchCCL();
        const ratios = await fetchRatios();

        const tbody = document.getElementById("tablaCedears");
        tbody.innerHTML = "";

        for (let cedear of cedears) {
          const symbol = cedear.symbol;
          const precioARS = cedear.c;  // precio actual en ARS
          const pct_change_ars = cedear.pct_change; // cambio % en ARS

          // Obtener el precio en USD actual y previo
          const usdData = await fetchUSDPrice(symbol);
          const precioUSD = usdData.price;
          const prevUSD = usdData.previousClose;

          // Ratio para este CEDEAR
          const ratio = ratios[symbol] || 1;

          // Cálculo del teórico en ARS
          const teoricoARS = precioUSD * ccl / ratio;

          // Spread % entre ARS real y teórico
          const spread = ( (precioARS - teoricoARS) / teoricoARS ) * 100;

          // Cambios en ARS: ya tenés pct_change_ars
          const cambioARS = pct_change_ars;

          // Cambio USD: ((precioUSD - prevUSD) / prevUSD) * 100
          let cambioUSD = 0;
          if (prevUSD && prevUSD > 0) {
            cambioUSD = ((precioUSD - prevUSD) / prevUSD) * 100;
          }

          // Flechita para ARS
          const flechaARS = cambioARS > 0 ? "▲" : (cambioARS < 0 ? "▼" : "");
          // Flechita para USD
          const flechaUSD = cambioUSD > 0 ? "▲" : (cambioUSD < 0 ? "▼" : "");

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${symbol}</td>
            <td>${precioARS.toFixed(2)}</td>
            <td>${precioUSD.toFixed(2)}</td>
            <td>${ratio}:1</td>
            <td>${teoricoARS.toFixed(2)}</td>
            <td class="${spread >= 0 ? "positivo" : "negativo"}">${spread.toFixed(2)}%</td>
            <td class="${cambioARS >= 0 ? "positivo" : "negativo"}">
              ${flechaARS} ${cambioARS.toFixed(2)}%
            </td>
            <td class="${cambioUSD >= 0 ? "positivo" : "negativo"}">
              ${flechaUSD} ${cambioUSD.toFixed(2)}%
            </td>
          `;
          tbody.appendChild(tr);
        }

      } catch (err) {
        console.error("Error al actualizar tabla:", err);
      }
    }

    // Al iniciar y refrescar cada 60 segundos
    actualizarTabla();
    setInterval(actualizarTabla, 60000);
  </script>
</body>
</html>
