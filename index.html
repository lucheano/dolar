<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Debug Arbitraje CEDEARs</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f9f9f9; padding:20px; }
    table { border-collapse: collapse; width:100%; background:#fff; font-size:14px; }
    th, td { border:1px solid #ccc; padding:6px; text-align:center; }
    th { background:#333; color:#fff; }
    tr:nth-child(even){ background:#f4f4f4; }
    .positivo{ color:green; font-weight:bold; }
    .negativo{ color:red; font-weight:bold; }
    .muted{ color:#777; }
  </style>
</head>
<body>

<h1>Debug Arbitraje CEDEARs</h1>
<p>Abre la consola del navegador (F12 ‚Üí Consola) para ver los logs de ejecuci√≥n.</p>

<table>
  <thead>
    <tr>
      <th>Ticker</th>
      <th>Ratio</th>
      <th>Cotizaci√≥n USA (USD)</th>
      <th>Precio CEDEAR (ARS)</th>
      <th>Precio CEDEAR (USD)</th>
      <th>Precio Esperado (ARS)</th>
      <th>Diferencia % ARS</th>
      <th>Diferencia % USD</th>
    </tr>
  </thead>
  <tbody id="tabla"></tbody>
</table>

<script>
const URL_CEDEARS = "https://data912.com/live/arg_cedears";
const URL_DOLAR = "https://dolarapi.com/v1/dolares";
const URL_RATIOS = "https://dolarhoy.dev.ar/ratios.json";

const fmt = (x, d=2) => (x==null || isNaN(x)) ? "‚Äì" : Number(x).toFixed(d);
const arrow = v => v>0 ? "‚ñ≤" : v<0 ? "‚ñº" : "";
const clsPN = v => v>0 ? "positivo" : v<0 ? "negativo" : "muted";

// === Yahoo Finance ===
async function getPrecioUSDYahoo(symbol) {
  const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}`;
  console.log("Consultando Yahoo:", url);
  try {
    const r = await fetch(url);
    if (!r.ok) {
      console.warn(`‚ùå Yahoo ${symbol}: respuesta HTTP ${r.status}`);
      return null;
    }
    const j = await r.json();
    const meta = j.chart?.result?.[0]?.meta;
    const price = meta?.regularMarketPrice ?? null;
    console.log(`‚úÖ ${symbol}: precio en USA =`, price);
    return price;
  } catch (err) {
    console.error(`‚ö†Ô∏è Error al obtener ${symbol} de Yahoo:`, err);
    return null;
  }
}

async function fetchJSON(url) {
  const res = await fetch(url);
  const txt = await res.text();
  try {
    const j = JSON.parse(txt);
    console.log("‚úÖ Cargado:", url, "‚Üí", j.length || Object.keys(j).length, "registros");
    return j;
  } catch (e) {
    console.error("‚ùå Error parseando JSON:", url, e);
    console.log(txt.slice(0,300));
    return null;
  }
}

async function loadData() {
  try {
    console.log("üöÄ Iniciando carga...");
    const [cedears, dolarData, ratiosData] = await Promise.all([
      fetchJSON(URL_CEDEARS),
      fetchJSON(URL_DOLAR),
      fetchJSON(URL_RATIOS)
    ]);

    const ccl = dolarData.find(d => d.casa === "contadoconliqui")?.venta;
    console.log("üíµ CCL venta:", ccl);

    const ratios = ratiosData.ratios || ratiosData;
    const mapRatios = Object.fromEntries(ratios.map(r => [r.ticker, r.ratio]));
    const mapCedears = Object.fromEntries(cedears.map(c => [c.symbol, c]));

    const tbody = document.getElementById("tabla");
    tbody.innerHTML = "";

    for (const symbol in mapCedears) {
      if (symbol.endsWith("D")) continue;
      const cedearARS = mapCedears[symbol];
      const cedearUSD = mapCedears[symbol + "D"];
      const ratio = mapRatios[symbol];
      if (!ratio) {
        console.log(`‚è≠Ô∏è ${symbol}: sin ratio definido`);
        continue;
      }

      const precioARS = Number(cedearARS?.c) || 0;
      const precioUSD = Number(cedearUSD?.c) || 0;
      console.log(`üìä ${symbol}: ARS=${precioARS}, USD=${precioUSD}, ratio=${ratio}`);

      const precioRealUSA = await getPrecioUSDYahoo(symbol);
      if (!precioRealUSA) {
        console.warn(`‚ö†Ô∏è ${symbol}: no se encontr√≥ en Yahoo`);
        continue;
      }

      const precioEsperadoARS = precioRealUSA * ratio * ccl;
      const diffARS = ((precioARS - precioEsperadoARS) / precioEsperadoARS) * 100;
      const diffUSD = ((precioUSD - precioRealUSA) / precioRealUSA) * 100;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${symbol}</td>
        <td>${ratio}:1</td>
        <td>${fmt(precioRealUSA)}</td>
        <td>${fmt(precioARS)}</td>
        <td>${fmt(precioUSD)}</td>
        <td>${fmt(precioEsperadoARS)}</td>
        <td class="${clsPN(diffARS)}">${arrow(diffARS)} ${fmt(diffARS)}%</td>
        <td class="${clsPN(diffUSD)}">${arrow(diffUSD)} ${fmt(diffUSD)}%</td>
      `;
      tbody.appendChild(tr);
    }

    console.log("‚úÖ Carga completa.");

  } catch (e) {
    console.error("‚ùå Error general:", e);
    document.getElementById("tabla").innerHTML =
      `<tr><td colspan="8" class="muted">Error al cargar datos.</td></tr>`;
  }
}

loadData();
</script>

</body>
</html>
