<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Monitor CEDEARs — DolarHoy.Dev</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f9f9f9; padding:20px; }
    table { border-collapse: collapse; width:100%; font-size:14px; background:#fff; }
    th, td { border:1px solid #ccc; padding:6px; text-align:center; }
    th { background:#333; color:#fff; }
    tr:nth-child(even){ background:#f4f4f4; }
    .positivo{ color:green; font-weight:bold; }
    .negativo{ color:red; font-weight:bold; }
    .muted{ color:#777; }
  </style>
</head>
<body>

<h1>Monitor CEDEARs — Data912 (via dolarhoy.dev.ar)</h1>
<p>Datos de <strong>dolarhoy.dev.ar/dolarccs.json</strong> y CCL venta de <strong>dolarapi.com</strong>. Refresca cada 30 s.</p>

<table>
  <thead>
    <tr>
      <th>Ticker</th>
      <th>Tipo de Cambio (CCL_mark)</th>
      <th>Cambio % (vs CCL_close)</th>
      <th>Spread vs CCL venta</th>
      <th>Volumen ARS</th>
      <th>Arbitrado</th>
    </tr>
  </thead>
  <tbody id="cedearTable"></tbody>
</table>

<script>
const URL_JSON = "https://dolarhoy.dev.ar/dolarccs.json";
const URL_DOLAR = "https://dolarapi.com/v1/dolares";
const UMBRAL_ARBITRAJE = 1.0; // ±1%

async function fetchJSON(url) {
  const res = await fetch(url);
  const txt = await res.text();
  console.log("Respuesta cruda desde", url, ":", txt.slice(0, 200)); // <- Debug
  try {
    return JSON.parse(txt);
  } catch (e) {
    console.error("No se pudo parsear JSON:", e);
    return null;
  }
}

async function loadData() {
  try {
    const [json, dolarData] = await Promise.all([
      fetchJSON(URL_JSON),
      fetchJSON(URL_DOLAR)
    ]);

    const cclVenta = dolarData?.find(d => d.casa === "contadoconliqui")?.venta ?? null;
    console.log("CCL venta:", cclVenta);

    const tbody = document.getElementById("cedearTable");
    tbody.innerHTML = "";

    if (!Array.isArray(json)) {
      tbody.innerHTML = `<tr><td colspan="6" class="muted">No se obtuvieron datos válidos del JSON.</td></tr>`;
      return;
    }

    json.forEach(item => {
      const ticker = item.ticker_ar || item.ticker_usa || item.symbol || "-";
      const mark = Number(item.CCL_mark) || 0;
      const close = Number(item.CCL_close) || 0;
      const vol = Number(item.ars_volume) || 0;

      const cambio = close ? ((mark - close) / close) * 100 : 0;
      const spread = cclVenta ? ((mark - cclVenta) / cclVenta) * 100 : 0;
      const arbitrado = Math.abs(spread) <= UMBRAL_ARBITRAJE;

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${ticker}</td>
        <td>${mark.toFixed(2)}</td>
        <td class="${cambio >= 0 ? "positivo" : "negativo"}">
          ${cambio >= 0 ? "▲" : "▼"} ${cambio.toFixed(2)}%
        </td>
        <td class="${spread >= 0 ? "positivo" : "negativo"}">${spread.toFixed(2)}%</td>
        <td>${vol.toLocaleString()}</td>
        <td>${arbitrado ? "Sí" : "No"}</td>
      `;
      tbody.appendChild(row);
    });

  } catch (error) {
    console.error("Error general:", error);
    document.getElementById("cedearTable").innerHTML =
      `<tr><td colspan="6" class="muted">Error al cargar datos.</td></tr>`;
  }
}

loadData();
setInterval(loadData, 30000);
</script>

</body>
</html>
