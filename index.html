<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>CEDEARs — Monitor (Data912 CCL)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; background:#f9f9f9; padding:20px; }
    table { border-collapse: collapse; width:100%; font-size:14px; background:#fff; }
    th, td { border:1px solid #ccc; padding:6px; text-align:center; }
    th { background:#333; color:#fff; }
    tr:nth-child(even){ background:#f4f4f4; }
    .pos { color:green; font-weight:bold; }
    .neg { color:red; font-weight:bold; }
    .muted { color:#777; }
    .left { text-align:left; }
  </style>
</head>
<body>

<h1>CEDEARs — Monitor</h1>
<p>Fuente: <strong>dolarhoy.dev.ar/dolarccs.json</strong> (espejo de Data912 /live/ccl) + <strong>dolarapi.com</strong> (CCL venta). Refresco cada 20s.</p>

<table id="tabla">
  <thead>
    <tr>
      <th class="left">Ticker</th>
      <th>Precio ARS ↓</th>
      <th>Cambio ARS</th>
      <th>Precio USD</th>
      <th>Cambio USD</th>
      <th>Tipo de Cambio</th>
      <th>Volumen</th>
      <th>Arbitrado</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const URL_DATA = "https://dolarhoy.dev.ar/dolarccs.json"; // tu espejo de data912 /live/ccl
const URL_DOLAR = "https://dolarapi.com/v1/dolares";
const ARBIT_THRESH = 1.0; // ±1%

const $tbody = document.querySelector("#tabla tbody");

const fmt = (x, d=2) => (x==null || Number.isNaN(Number(x))) ? "–" : Number(x).toFixed(d);
const arrow = (v) => (v>0 ? "▲" : (v<0 ? "▼" : ""));
const clsPN = (v) => v>0 ? "pos" : (v<0 ? "neg" : "muted");

// Obtiene una propiedad sin importar mayúsculas/minúsculas y variaciones
function pick(obj, keys) {
  if (!obj) return null;
  const lower = {};
  for (const k of Object.keys(obj)) lower[k.toLowerCase()] = obj[k];
  for (const k of keys) {
    const v = lower[k.toLowerCase()];
    if (v !== undefined && v !== null) return v;
  }
  return null;
}

async function getJSON(url) {
  const r = await fetch(url);
  const txt = await r.text(); // algunos servidores no ponen header JSON
  try { return JSON.parse(txt); }
  catch(e){ console.error("No es JSON válido:", txt.slice(0,200)); return null; }
}

async function getCCLVenta() {
  const arr = await getJSON(URL_DOLAR);
  if (!Array.isArray(arr)) return null;
  const o = arr.find(x => x.casa === "contadoconliqui");
  return o ? Number(o.venta) : null;
}

function extractRow(raw) {
  // Intentamos múltiples alias por campo
  const ticker = pick(raw, ["ticker_ar","ticker","symbol","ticker_usa","s","code"]);

  const cclMark  = Number(pick(raw, ["CCL_mark","ccl_mark","mark","ccl"]));
  const cclBid   = Number(pick(raw, ["CCL_bid","ccl_bid","bid"]));
  const cclAsk   = Number(pick(raw, ["CCL_ask","ccl_ask","ask"]));
  const cclClose = Number(pick(raw, ["CCL_close","ccl_close","close","prev_close","previousclose"]));
  let tc = (isFinite(cclMark) && cclMark>0) ? cclMark : null;
  if (tc==null) {
    const avg = (isFinite(cclBid)?cclBid:NaN) + (isFinite(cclAsk)?cclAsk:NaN);
    if (isFinite(cclBid) && isFinite(cclAsk)) tc = avg/2;
    else if (isFinite(cclBid)) tc = cclBid;
    else if (isFinite(cclAsk)) tc = cclAsk;
  }

  const vol = Number(pick(raw, ["ars_volume","volume","vol","arsvol"]));

  // % cambio con base en CCL (si hay close)
  const cambioCCL = (tc!=null && isFinite(cclClose) && cclClose!==0) ? ((tc - cclClose)/cclClose)*100 : null;

  return { ticker, tc, cclClose, vol, cambioCCL };
}

async function render() {
  try {
    const [arr, cclVenta] = await Promise.all([getJSON(URL_DATA), getCCLVenta()]);
    $tbody.innerHTML = "";

    if (!Array.isArray(arr) || arr.length===0) {
      $tbody.innerHTML = `<tr><td colspan="8" class="muted">No se recibieron datos.</td></tr>`;
      return;
    }

    // Debug: mostrar un ejemplo en consola para validar estructura real
    console.log("Ejemplo de fila recibida:", arr[0]);

    for (const raw of arr) {
      const { ticker, tc, cclClose, vol, cambioCCL } = extractRow(raw);

      // Spread vs CCL venta
      const spread = (tc!=null && cclVenta!=null && cclVenta!==0) ? ((tc - cclVenta)/cclVenta)*100 : null;
      const arbitrado = (spread!=null) ? Math.abs(spread) <= ARBIT_THRESH : false;

      // Estas 4 columnas requieren fuentes adicionales que /live/ccl no trae -> mostramos “–”
      const precioARS = null, cambioARS = null, precioUSD = null, cambioUSD = null;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="left">${ticker || "–"}</td>
        <td>${fmt(precioARS)}</td>
        <td class="${clsPN(cambioARS)}">${cambioARS==null?"–":(arrow(cambioARS)+" "+fmt(cambioARS,2)+"%")}</td>
        <td>${fmt(precioUSD)}</td>
        <td class="${clsPN(cambioUSD)}">${cambioUSD==null?"–":(arrow(cambioUSD)+" "+fmt(cambioUSD,2)+"%")}</td>
        <td>${fmt(tc)}</td>
        <td>${vol==null ? "–" : Number(vol).toLocaleString()}</td>
        <td><span class="${arbitrado?'pos':'neg'}">
