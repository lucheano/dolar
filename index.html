<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>CEDEARs — Monitor</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f9f9f9; padding:20px; }
    table { border-collapse: collapse; width:100%; background:#fff; font-size:14px; }
    th, td { border:1px solid #ddd; padding:8px; text-align:center; }
    th { background:#333; color:#fff; }
    tr:nth-child(even) td { background:#fafafa; }
    .pos { color: #0a7d11; font-weight:600; }
    .neg { color: #c5162b; font-weight:600; }
    .muted { color:#777; }
    .left { text-align:left; }
    #err { color:#c5162b; margin:8px 0 0; font-size:13px; }
  </style>
</head>
<body>

<h1>CEDEARs — Monitor</h1>
<p>Fuentes: <strong>data912.com/live/arg_cedears</strong> (tipo de cambio implícito y volumen) + <strong>dolarapi.com</strong> (CCL venta). Refresco cada 60s.</p>
<div id="err"></div>

<table id="t">
  <thead>
    <tr>
      <th class="left">Ticker</th>
      <th>Precio ARS ↓</th>
      <th>Cambio ARS</th>
      <th>Precio USD</th>
      <th>Cambio USD</th>
      <th>Tipo de Cambio</th>
      <th>Volumen</th>
      <th>Arbitrado</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const DOLARAPI_URL = "https://dolarapi.com/v1/dolares";
const DATA912_URL  = "https://data912.com/live/arg_cedears"; // directo, sin proxies
const ARBIT_THRESH_PCT = 1.0; // ±1%

const $tbody = document.querySelector("#t tbody");
const $err   = document.querySelector("#err");

const fmt = (x, d=2) => (x==null || Number.isNaN(Number(x))) ? "–" : Number(x).toFixed(d);
const arrow = (v) => (v>0 ? "▲" : (v<0 ? "▼" : ""));
const clsPN = (v) => v>0 ? "pos" : (v<0 ? "neg" : "muted");

async function fetchJSON(url) {
  const r = await fetch(url);
  // Algunos servidores responden con JSON válido aunque el header no sea application/json
  const txt = await r.text();
  try { return JSON.parse(txt); }
  catch(e) {
    console.error("Respuesta no JSON de", url, txt.slice(0,200));
    throw new Error("La respuesta no es JSON válido: " + url);
  }
}

async function getCCLVenta() {
  const arr = await fetchJSON(DOLARAPI_URL);
  const ccl = Array.isArray(arr) ? arr.find(x => x.casa === "contadoconliqui") : null;
  return ccl ? Number(ccl.venta) : null;
}

function getCCLFromRow(row) {
  // Preferimos CCL_mark; si no viene, promedio bid/ask; si no, null
  if (row.CCL_mark != null) return Number(row.CCL_mark);
  if (row.CCL_bid != null && row.CCL_ask != null) return (Number(row.CCL_bid) + Number(row.CCL_ask)) / 2;
  if (row.CCL_bid != null) return Number(row.CCL_bid);
  if (row.CCL_ask != null) return Number(row.CCL_ask);
  return null;
}

async function refresh() {
  $err.textContent = "";
  try {
    const [cclVenta, data] = await Promise.all([getCCLVenta(), fetchJSON(DATA912_URL)]);
    if (!Array.isArray(data) || data.length === 0) {
      $tbody.innerHTML = `<tr><td colspan="8" class="muted">Sin datos de data912.</td></tr>`;
      return;
    }

    $tbody.innerHTML = "";
    for (const row of data) {
      // Campos esperados por data912:
      // ticker_usa, ticker_ar, CCL_bid, CCL_ask, CCL_close, CCL_mark, ars_volume, ...
      const ticker = (row.ticker_ar || row.ticker_usa || "").toString();
      const tc     = getCCLFromRow(row); // Tipo de cambio implícito
      const tcClose= row.CCL_close != null ? Number(row.CCL_close) : null;
      const volARS = row.ars_volume != null ? Number(row.ars_volume) : null;

      // Cambio CCL (%) = (tc - tcClose)/tcClose
      const cambioCCL = (tc!=null && tcClose!=null && tcClose!==0) ? ((tc - tcClose)/tcClose)*100 : null;

      // Spread vs CCL venta (%)
      const spread = (tc!=null && cclVenta!=null && cclVenta!==0) ? ((tc - cclVenta)/cclVenta)*100 : null;

      // Arbitrado si |spread| <= umbral
      const arbitrado = (spread!=null) ? Math.abs(spread) <= ARBIT_THRESH_PCT : false;

      // NOTA: Data912 no trae Precio ARS del CEDEAR ni Precio USD del subyacente -> mostramos "–"
      const precioArs  = null; // Se requiere otra fuente para CEDEAR last en ARS
      const cambioArs  = null; // Idem (var % del CEDEAR en ARS)
      const precioUsd  = null; // Se requiere otra fuente (USA)
      const cambioUsd  = null; // Idem

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="left">${ticker || "–"}</td>
        <td>${fmt(precioArs)}</td>
        <td class="${clsPN(cambioArs)}">${cambioArs==null ? "–" : (arrow(cambioArs)+" "+fmt(cambioArs,2)+"%")}</td>
        <td>${fmt(precioUsd)}</td>
        <td class="${clsPN(cambioUsd)}">${cambioUsd==null ? "–" : (arrow(cambioUsd)+" "+fmt(cambioUsd,2)+"%")}</td>
        <td>${fmt(tc)}</td>
        <td>${volARS==null ? "–" : volARS.toLocaleString()}</td>
        <td><span class="${arbitrado?'pos':'neg'}">${arbitrado ? 'Sí' : 'No'}</span></td>
      `;
      $tbody.appendChild(tr);
    }
  } catch(err) {
    console.error(err);
    $err.textContent = "No pude leer los datos. Detalle en consola.";
    // Pintamos una fila placeholder para que no quede la tabla vacía
    $tbody.innerHTML = `<tr><td colspan="8" class="muted">Error al cargar. Revisá la consola (F12).</td></tr>`;
  }
}

refresh();
setInterval(refresh, 60000);
</script>

</body>
</html>
